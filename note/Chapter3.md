# 三维空间刚体运动

<B>主要目标</B>

> 1. 理解三维空间的刚体运动描述方式：旋转矩阵、变换矩阵、四元数和欧拉角。
> 2. 掌握Eigen库的矩阵、几何模块的使用方法。

本节介绍视觉SLAM的基本问题之一：<B>如何描述刚体在三维空间中的运动</B>

直观上，我们知道这由一次旋转加一次平移组成。

平移没有太大问题，但旋转的处理是一件很麻烦的事，我们将介绍旋转矩阵、四元数、欧拉角的意义，以及它们是如何运算和转换的。

# 3.1 旋转矩阵

## 3.1.1 点、向量和坐标系

刚体在三维空间中不光有位置，还有自身的姿态。位置是指刚体在空间中的哪个地方，而姿态则是指刚体的朝向。在数学中，使用点和向量来描述。

任意向量在空间的一组基($e_1,e_2,e_3$)下的坐标：

$$
a = [e_1, e_2, e_3]\left[
\begin{matrix}
a_1 \\
a_2 \\
a_3
\end{matrix}
\right] = a_1e_1+a_2e_2+a_3e_3
$$

这里$(a_1,a_2,a_3)^T$称为$a$在此基下的坐标。坐标的具体取值，一是和向量本身有关，二是和坐标系(基)的选取有关。坐标系通常由3个正交的坐标轴组成。

外积：

$$
a \cdot b = \begin{Vmatrix} 
e_1 & e_2 & e_3 \\
a_1 & a_2 & a_3 \\
b_1 & b_2 & b_3
\end{Vmatrix} = 
\begin{bmatrix}
a_2 b_3 - a_3 b_2 \\
a_3 b_1 - a_1 b_3 \\
a_1 b_2 - a_2 b_1
\end{bmatrix} = 
\begin{bmatrix}
0 & -a_3 & a_2 \\
a_3 & 0 & -a_1 \\
-a_2 & a_1 & 0
\end{bmatrix}b \overset{def}{=} a ^\wedge b.
$$

外积的结果是一个向量，它的方向垂直于这两个向量，大小为$\lvert a \rvert \lvert b \rvert sin\lang a,b \rang $，是两个向量张成的四边形的有向面积。

对于外积运算，我们引入$^\wedge$符号，把$a$写成一个矩阵。事实上是一个<B>反对称矩阵</B>(Skew-symmetric Matrix)，可以将$^\wedge$记成一个反对称符号。这样就把外积$a\times b$写成了矩阵向量的乘法$a^\wedge b$，把它变成了线性运算。

此符号是一个一一映射，意味着任意向量都对应着唯一的一个反对称矩阵，反之亦然：

$$
a^\wedge=\begin{bmatrix}
0 & -a_3 & a_2 \\
a_3 & 0 & -a_1 \\
-a_2 & a_1 & 0
\end{bmatrix}
$$

## 3.1.2 坐标系间的欧式变换

如下图所示，$x_W,y_W,z_W$定义的坐标系是一个世界坐标系，机器人是一个移动坐标系$x_C,y_C,z_C$定义的坐标系。
<div align=center>
    <img src="./image/坐标变换.png" \>
</div>

相机视野中某个向量$p$，它在相机坐标系下的坐标为$p_c$，而从世界坐标系下看，它的坐标为$p_w$，那么，这两个坐标系之间是如何转换的？

这时，就需要先得到该点针对机器人坐标系的坐标值，再根据机器人位姿变换到世界坐标系中。

两个坐标系之间的运动由一个旋转加上一个平移组成，这种运动称为<B>刚体运动</B>，我们说手机坐标系到世界坐标系之间，相差了一个<B>欧式变换</B>(Euclidean Transform)。

欧式变换由旋转和平移组成，首先考虑旋转，假设某个单位正交基$(e_1,e_2,e_3)$经过一次旋转变成了$(e_1^{'},e_2^{'},e_3^{'})$，那么，对于同一个向量$a$它在两个坐标系下的坐标为$[a_1,a_2,a_3]^T$和$[a_1',a_2',a_3']^T$。因为向量本身没变，所以根据坐标的定义有：

$$
[e_1,e_2,e_3]\begin{bmatrix} a_1 \\ a_2 \\ a_3 \end{bmatrix} = [e'_1,e'_2,e'_3]\begin{bmatrix} a'_1 \\ a'_2 \\ a'_3 \end{bmatrix}
$$

为了描述两个坐标系之间的关系，我们对上述等式的左右两边同时左乘$\begin{bmatrix} a^T_1 \\ a^T_2 \\ a^T_3 \end{bmatrix}$，那么左边的系数就变成了单位矩阵，所以：

$$
\begin{bmatrix} a_1 \\ a_2 \\ a_3 \end{bmatrix} = 
\begin{bmatrix}
e^T_1e'_1 & e^T_1e'_2 & e^T_1e'_3 \\
e^T_2e'_1 & e^T_2e'_2 & e^T_2e'_3 \\
e^T_3e'_1 & e^T_3e'_2 & e^T_3e'_3
\end{bmatrix}
\begin{bmatrix} a'_1 \\ a'_2 \\ a'_3 \end{bmatrix} \overset{def}{=}Ra'.
$$

把中间的矩阵拿出来，定义成一个矩阵$R$，这个矩阵由两组基之间的内积组成，刻画了旋转前后同一个向量的坐标变换关系。只要旋转是一样的，这个矩阵就是一样的。可以说，矩阵$R$描述了旋转本身。因此，称为<B>旋转矩阵</B>(Rotation Matrix)。同时，该矩阵各分量是两个坐标系基的内积，由于基向量的长度为1，所以实际上是各基向量的余弦值。所以这个矩阵也叫<B>方向余弦矩阵</B>(Direction Cosine Matrix)。

旋转矩阵有一些性质：它是一个行列式为1的正交矩阵。反之，行列式为1的正交矩阵也是一个旋转矩阵。所以，可以将n维旋转矩阵的集合定义如下：

$$
SO(n)=\{R\in \Re^{n\times n} | RR^T=I,det(R)=1\}.
$$

$SO(n)$是<B>特殊正交群</B>(Special Orthogonal Group)的意思，这个集合由$n$维空间的旋转矩阵组成，特别地，$SO(3)$就是指三维空间的旋转。通过旋转矩阵，可以直接谈论两个坐标系之间的旋转变换，而不用再从基开始谈起。

由于旋转矩阵为正交矩阵，它的逆(即转置)描述了一个相反的旋转。按照上面的定义方式有：

$$
a'=R^{-1}a=R^Ta.
$$

在欧氏变换中，除了旋转还有平移。考虑世界坐标系中的向量$a$，经过一次旋转(用$R$描述)和一次平移$t$后，得到了$a'$，那么把旋转和平移合到一起，有

$$
a'=Ra+t.
$$

> 其中，$t$称为平移向量。相比于旋转，平移部分只需要把平移向量加到旋转之后的坐标上。
> 通过上式，我们用一个旋转矩阵$R$和一个平移向量$t$完整地描述了一个欧氏空间的坐标变换关系。

实际当中，我们会定义坐标系1、坐标系2，那么向量$a$在两个坐标系下的坐标为$a_1$，$a_2$，它们之间的关系应该是：

$$
a_1=R_{12}a_2+t_{12}.
$$

这里的$R_{12}$是指“把坐标系2的向量变换到坐标系1”中，由于向量乘在这个矩阵的右边，它的下标是<B>从右读到左</B>的。如果要表达“从1到2的旋转矩阵”时，就写成$R_{21}$。

关于平移$t_{12}$，它实际对应的是坐标系1原点指向坐标系2原点的向量，<B>在坐标系1下取的坐标</B>，记作“从1到2的向量”。
但是反过来的$t_{21}$，即从2指向1的向量在坐标系2下的坐标，却并不等于$-t_{12}$，而是和两个系的旋转还有关系。

## 3.1.3 变换矩阵与齐次坐标

假设进行了两次欧氏空间的旋转与平移：$R_1,t_1$和$R_2,t_2$:

$$
b = R_1a + t_1, \quad c = R_2b + t_2.
$$
那么从$a$到$c$的变换为：

$$
c=R_2(R_1a + t_1) + t_2.
$$

可以发现，这里的变换关系不是一个线性关系。这样的形式在变换多次之后会显得很啰嗦，因此，我们引入齐次坐标和变换矩阵，重写：

$$
\begin{bmatrix} a' \\ 1 \end{bmatrix} = 
\begin{bmatrix} R & t \\ 0^T & 1 \end{bmatrix}
\begin{bmatrix} a \\ 1 \end{bmatrix} \overset{def}{=}
T \begin{bmatrix} a \\ 1 \end{bmatrix}
$$

> 这是一个数学技巧：我们在一个三维向量的末尾添加1，将其变成了四维向量，称为<B>齐次坐标</B>。对于这个四维向量，我们可以把旋转和平移写在一个矩阵里，使得整个关系变成线性关系。该式中，矩阵$T$称为<B>变换矩阵(Transform Matrix)</B>。


暂时用$\widetilde{a}$表示$a$的齐次坐标，那么依靠齐次坐标和变换矩阵，两次变换的叠加就可以有很好的形式：

$$
\widetilde{b}=T_1 \widetilde{a}, \widetilde{c}=T_2 \widetilde{b} \quad \Rightarrow \widetilde{c}=T_2T_2\widetilde{a}.
$$

> 区分齐次和非齐次坐标的符号令人厌烦，在不引起歧义的情况下，以后直接把它写成$b=Ta$的样子，默认进行了齐次坐标的转换。

关于变换矩阵$T$，它具有比较特别的结构：左上角为旋转矩阵，右侧为平移向量，左下角为$0$向量，右下角为$1$。这种矩阵又称为特殊欧氏群(Special Euclidean Group):

$$
SE(3)=\left\{ T=\begin{bmatrix} R & t \\ 0^T & 1 \end{bmatrix} \in \mathbb{R}^{4\times 4}|R\in SO(3),t\in \mathbb{R}^3 \right\}.
$$

与$SO(3)$一样，求解该矩阵的逆表示一个反向的变换：

$$
T^{-1}=\begin{bmatrix} R^T & -R^Tt \\ 0^T & 1 \end{bmatrix}.
$$

> 同样，我们用$T_{12}$这样的写法来表示从2到1的变换。


<B>回顾：</B>首先，我们介绍了向量及其坐标表示，并介绍了向量间的运算；然后，坐标系之间的运动由欧氏变换描述，它由平移和旋转组成。旋转可以由旋转矩阵$SO(3)$描述，而平移直接由一个$\mathbb{R}^3$向量描述。最后，如果将平移和旋转放一个矩阵中，就形成了变换矩阵$SE(3)$。

# 3.3 旋转向量和欧拉角

## 3.3.1 旋转向量

https://www.latexlive.com/##