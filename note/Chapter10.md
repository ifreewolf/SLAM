# 第10讲 后端2

<div style="border: 1px solid black;">
<B>主要目标</B>

1. 理解滑动窗口优化。
2. 理解位姿图优化。
3. 理解带IMU紧耦合的优化。
4. 通过实验掌握g2o的位姿图。
</div>

第9讲重点介绍了以BA为主的图优化。BA能精确地优化每个相机位姿与特征点位置。不过在更大的场景中，大量特征点的存在会严重降低计算效率，导致计算量越来越大，以至于无法实时化。本讲的第一部分将介绍一种简化的BA：位姿图。

## 10.1 滑动窗口滤波和优化

### 10.1.1 实际环境下的BA结构

带有相机位姿和空间点的图优化称为BA，它能够有效地求解大规模的定位与建图问题。这在SfM问题中十分有用，但是在SLAM过程中，我们往往需要控制BA的规模，保持计算的实时性。倘若计算能力无限，那不妨每时每刻都计算整个BA-但是那不符合现实需要。现实条件是，我们必须限制后端的计算时间，比如BA规模不能超过1万个路标点，迭代不超过20次，用时不超过0.5秒，等等。像SfM那样用一周时间重建一个城市地图的算法，在SLAM里不见得有效。

控制计算规模的做法有很多，比如从连续的视频中抽出一部分作为<B>关键帧</B>，仅构造关键帧与路标点之间的BA，于是非关键帧只用于定位，对建图则没有贡献。即便如此，随着时间的流逝，关键帧数量会越来越多，地图规模也将不断增长。像BA这样的批量优化方法，计算效率会(令人担忧地)不断下降。为了避免这种情况，我们需要用一定手段控制后端BA的规模。这些手段可以是理论上的，也可以是工程上的。

例如，最简单的控制BA规模的思路，是仅保留离当前时刻最近的$N$个关键帧，去掉时间上更早的关键帧。于是，我们的BA将固定在一个时间窗口内，离开这个窗口的则被丢弃。这种方法称为滑动窗口法。当然，取这$N$个关键帧的具体方法可以有一些改变，例如，不见得必须取时间上最近的，而可以按照某种原则，取时间上靠近，空间上又可以展开的关键帧，从而保证相机即使在停止不动时，BA的结构也不至于缩成一团(这容易导致一些糟糕的退化情况)。如果我们在帧与帧的结构上再考虑得深一些，也可以像ORB-SLAM2那样，定义一种称为“共试图”(Covisibility graph)的结构(如图10-1所示)。所谓共试图，就是指那些“与现在的相机存在共同观测的关键帧构成的图”。于是，在BA优化时，我们