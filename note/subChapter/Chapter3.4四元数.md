# Chapter3.4


## 3.4 四元数

### 3.4.1 四元数的定义

旋转矩阵用9个量描述3自由度的旋转，具有冗余性；欧拉角和旋转向量是紧凑的，但具有奇异性。事实上，<B>找不到不带奇异性的三维向量描述方式</B>。

回忆数学上的复数，用复数集$\mathbb{C}$表示复平面上的向量，而复数的乘法则表示复平面上的旋转：例如，乘上复数$i$相当于逆时针把一个复向量旋转$90\degree$。类似地，在表达三维空间旋转时，也有一种类似于复数的代数：<B>四元数(Quaternion)</B>。四元数是Hamilton找到的一种扩展的复数。它<B>既是紧凑的，也没有奇异性</B>。

缺点是，四元数不够直观，其运算稍复杂些。

当我们想将复平面的向量旋转$\theta$角时，可以给这个复向量乘以$e^{i\theta}$。这是极坐标表示的复数，它也可以写成普通的形式，只要用欧拉公式即可：

$$
e^{i\theta}=cos\theta + i sin\theta \tag{3.19}
$$

这正是一个单位长度的复数，所以在二维情况下，旋转可以由<B>单位复数</B>来描述，类似地，三维旋转可以由<B>单位四元数</B>来描述。

一个四元数$q$拥有一个实部和三个虚部。

$$
q=q_0 + q_1i + q_2 j + q_3 k, \tag{3.20}
$$

> 其中，$i,j,k$为四元数的三个虚部。这三个虚部满足以下关系式：

$$
\left\{\begin{matrix} 
  i^2=j^2=k^2=-1 \\
  ij=k,ji=-k \\
  jk=i,kj=-i \\
\end{matrix}\right.  \tag{3.21}
$$

> 如果把$i,j,k$看成三个坐标轴，那么它们于自己的乘法和复数一样，相互之间的乘法和外积一样。有时，人们也用一个标量和一个向量来表达四元数：

$$
\mathcal{q}=[s,v]^T, \quad s=q_0 \in \mathbb{R}, \quad v=[q_1, q_2, q_3]^T \in \mathbb{R}^3.
$$

> 这里，$s$称为四元数的实部，而$v$称为它的虚部。如果一个四元数的虚部为$0$，则称为<B>实四元数</B>；反之，若它的实部为0，则称为<B>虚四元数</B>。

可以用<B>单位四元数</B>表示三维空间中任意一个旋转，不过这种表达方式和复数有着微妙的不同。在复数中，乘以i意味着旋转90°，这是否意味着四元数中，乘i就是绕$i$轴旋转90°？那么ij=k是否意味着，先绕$i$轴旋转90°，再绕$j$轴转90°，就等于绕$k$轴转90°？正确的情形应该是，乘以i对应着旋转180°，这样才能保证$ij=k$的性质。而$i^2=-1$，意味着绕$i$轴旋转360°后得到一个相反的东西。这个东西要旋转两周才会和它原先的样子相等。

### 3.4.2 四元数的运算

现有两个四元数$q_a,q_b$，它们的向量表示为$[s_a,v_a]^T,[s_b,v_b]^T$，或者原始四元数表示为

$$
q_a=s_a + x_a i + y_a j + z_a k, \quad q_b = s_b + x_b i + y_b j + z_b k.
$$

1. 加法和减法

$$
q_a \pm q_b = [s_a \pm s_b, v_a \pm v_b]^T. \tag{3.22}
$$

2. 乘法

$$
\begin{aligned}
q_a q_b =&s_a s_b - x_a x_b - y_a y_b - z_a z_b \\
&+ (s_a x_b + x_a s_b + y_a z_b - z_a y_b)i \\
&+ (s_a y_b - x_a z_b + y_a s_b + z_a x_b)j \\
&+ (s_a z_b + x_a y_b - y_a x_b + z_a s_b)k. \tag{3.23}
\end{aligned}
$$

利用内外积运算，该表达式更加简洁：

$$
q_a q_b = [s_a s_b - v_a^Tv_b, s_a v_b + s_b v_a + v_a \times v_b]^T. \tag{3.24}
$$

> 因为外积的存在，四元数乘法通常是不可交换的，除非$v_a$和$v_b$在$\mathbb{R}^3$中共线，此时外积项为零。

3. 模长

$$
\lVert q_a \rVert=\sqrt{s_a^2 + x_a^2 + y_a^2 + z_a^2}. \tag{3.25}
$$

同时，两个四元数乘积的模即模的乘积，这使得单位四元数相乘仍是单位四元数。

$$
\lVert q_a q_b \rVert = \lVert q_a \rVert \lVert q_b \rVert. \tag{3.26}
$$

4. 共轭

$$
q_a^*=s_a - x_a i - y_a j - z_a k = [s_a, -v_a]^T. \tag{3.27}
$$
> 四元数的共轭是把虚部取成相反数。

四元数共轭与其本身相乘，会得到一个实四元数，其实部为模长的平方：

$$
q^* q = q q^* = [s_a^2 + v^Tv, 0]^T. \tag{3.28}
$$

5. 逆

$$
q^{-1} = q^* /\lVert q \rVert ^2. \tag{3.29}
$$

> 四元数和自己的逆的乘积为实四元数$\mathcal{1}$：

$$
qq^{-1}=q^{-1}q=1. \tag{3.30}
$$

> 如果$q$为单位四元数，其逆和共轭就是同一个量。同时，乘积的逆具有和矩阵相似的性质：
$$
(q_a q_b)^{-1} = q_b^{-1} q_a^{-1}. \tag{3.31}
$$

6. 数乘

$$
k\mathcal{q}=[ks, kv]^T. \tag{3.32}
$$

### 3.4.3 用四元数表示旋转

假设有一个空间三维点$p=[x,y,z]\in \mathbb{R}^3$，以及一个由单位四元数$q$指定的旋转。三维点$p$经过旋转之后变为$p'$。如果使用矩阵描述，那么有$p'=Rp$，如果使用四元数描述：

把三维空间点用一个虚四元数来描述：

$$
p=[0,x,y,z]^T=[0,v]^T.
$$

那么，旋转后的点$p'$可表示为这样的乘积：

$$
p'=qpq^{-1}. \tag{3.33}
$$

最后把$p'$的虚部取出，即得旋转之后点的坐标。

### 3.4.4 四元数到其他旋转表示的转换

任意单位四元数描述了一个旋转，该旋转也可以用旋转矩阵或旋转向量描述。

四元数乘法也可以写成一种矩阵的乘法，设$q=[s,v]^T$，那么，定义如下的符号$^+$和$^\oplus$为：

$$
q^+ = \begin{bmatrix} s & -v^T \\ v & sI + v^{\wedge} \end{bmatrix}, \quad 
q^{\oplus}=\begin{bmatrix} s & -v^T \\ v & sI - v^{\wedge} \end{bmatrix}. \tag{3.34}
$$

这两个符号将四元数映射成为一个4x4的矩阵。于是，四元数乘法可以写成矩阵的形式：

$$
q_1^+q_2=\begin{bmatrix} s_1 & -v_1^T \\ v_1 & s_1 I + v_1^{\wedge} \end{bmatrix} \begin{bmatrix} s_2 \\ v_2 \end{bmatrix} = 
\begin{bmatrix}
-v_1^T v_2 + s_1 s_2 \\
s_1 v_2 + s_2 v_1 + v_1^{\wedge} v_2
\end{bmatrix} = q_1 q_2. \tag{3.35}
$$

同理有：

$$
q_1 q_2 = q_1^+ q_2 = q_2^{\oplus} q_1. \tag{3.36}
$$

考虑使用四元数对空间点进行旋转的问题，根据前面的说法(式3.33)，有：

$$
\begin{aligned}
p' &= qpq^{-1}=q^+p^+q^{-1} \\
&= q^+q^{-1\oplus}p.
\end{aligned} \tag{3.37}
$$

代入两个符号对应的矩阵，得：

$$
q^+(q^{-1})^{\oplus}=\begin{bmatrix} s & -v^T \\ v & sI + v^{\wedge} \end{bmatrix}
\begin{bmatrix} s & v^T \\ -v & sI + v^{\wedge} \end{bmatrix}=
\begin{bmatrix} 1 & 0 \\ 0^T & vv^T + s^2I + 2sv^{\wedge} + (v^{\wedge})^2 \end{bmatrix}. \tag{3.38}
$$

因为$p'$和$p$都是虚四元数，所以上面矩阵得右下角即给出了<B>从四元数到旋转矩阵/B>的变换关系</B>：

$$
R=vv^T + s^2 I + 2sv^{\wedge} + (v^{\wedge})^2. \tag{3.39}
$$

为了得到四元数到旋转向量的转换公式，对上式两侧求迹，得：

$$
\begin{aligned}
tr(R) &= tr(vv^T + s^2 I + 2sv^{\wedge} + (v^{\wedge})^2) \\
&= v_1^2 + v_2^2 + v_3^2 + 3s^2 - 2(v_1^2 + v_2^2 + v_3^2) \\
&= (1-s^2) + 3s^2 - 2(1-s^2) \\
&= 4s^2 - 1.
\end{aligned} \tag{3.40}
$$

又由式(3.17)得
$$
\begin{aligned}
\theta &= arccos\frac{tr(R-1)}{2} \\
&= arccos(2s^2 - 1).
\end{aligned} \tag{3.41}
$$

即

$$
cos\theta = 2s^2 -1 = scos^2\frac{\theta}{2}-1. \tag{3.42}
$$

所以：
$$
\theta = 2arccos\ s \tag{3.43}
$$

至于旋转轴，如果在式(3.38)中用$q$的虚部代替$p$，易知$q$的虚部组成的向量在旋转时是不动的，即构成旋转轴。于是只要将它除掉它的模长，即得。总而言之，四元数到旋转向量的转换公式如下：

$$
\left\{
  \begin{aligned}
  & \theta = 2arccos\ q_0 \\
  & [n_x, n_y, n_z]^T = [q_1, q_2, q_3]^T / sin\frac{\theta}{2}
  \end{aligned}
\right. \tag{3.44}
$$

至于如何从其他方式转换到四元数，只需把上述步骤倒过来处理即可。在实际编程中，程序库通常会为我们准备好各种形式之间的转换。无论四元数、旋转矩阵还是轴角，它们都可以用来描述同一个旋转。

