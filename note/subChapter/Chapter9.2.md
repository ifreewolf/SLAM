## 9.2 BA与图优化

所谓的Bundle Adjustment（BA），是指从视觉图像中提炼出最优的3D模型和相机参数(内参数和外参数)。考虑从任意特征点发射出来的几束光线(bundles of light rays)，它们会在几个相机的成像平面上变成像素或是检测到的特征点。如果我们调整(adjustment)各相机姿态和各特征点的空间未知，使得这些光线最终收束到相机的光心，就称为BA。

在第5讲和第7讲已经简单介绍过BA的原理，本节的重点是介绍它对应的图模型结构的特点，然后介绍一些通用的快速求解方法。

### 9.2.1 投影模型和BA代价函数

从一个世界坐标系中的点$p$出发，把相机的内外参数和畸变都考虑进来，最后投影成像素坐标，需要如下步骤。

1. 把世界坐标转换到相机坐标，这里将用到相机外参数($R,t$):

$$
P' = Rp + t = [X', Y', Z']^T. \tag{9.36}
$$

2. 将$P'$投至归一化平面，得到归一化坐标：

$$
P_c = [u_c, v_c, 1]^T = [X'/Z', Y'/Z', 1]^T. \tag{9.37}
$$

3. 考虑归一化坐标的畸变情况，得到去畸变前的原始像素坐标。这里暂时只考虑径向畸变：

$$
\left\{
    \begin{array}{l}
        u_c' = u_c(1 + k_1 r_c^2 + k_2 r_c^4) \\
        v_c' = v_c(1 + k_1 r_c^2 + k_2 r_c^4)
    \end{array}. \tag{9.38}
\right.
$$

4. 根据内参模型，计算像素坐标：

$$
\left\{
    \begin{array}{l}
        u_s = f_x u_c' + c_x \\
        v_s = f_y v_c' + c_y
    \end{array}. \tag{9.39}
\right.
$$

这一系列计算流程看似复杂，用下面的流程图形象化地表示整个过程，以帮助理解。这个过程就是前面讲的<B>观测方程</B>，之前我们把它抽象地记成：

$$
z = h(x,y). \tag{9.40}
$$

<div align=center>
    <img src="../image/计算流程示意图.png" />
</div>

> 左侧的$p$是全局坐标系下的三维坐标点，右侧的$u_s,v_s$是该点在图像平面上的最终像素坐标。中间畸变模块中的$r_c^2 = u_c^2 + v_c^2$

现在，我们给出了它的详细参数化过程。具体地说，这里的$x$指代此时相机的位姿，即外参$R,t$，它对应的李群为$T$，李代数为$\xi$。路标$y$即这里的三维点$p$，而观测数据则是像素坐标$z \overset{def}{=}[u_s,v_s]^T$。以最小二乘的角度来考虑，那么可以列写关于此次观测的误差：

$$
e = z - h(T, p). \tag{9.41}
$$

然后，把其他时刻的观测量也考虑进来，我们可以给误差添加一个下标。设$z_{ij}$为在位姿$T_i$处观察路标$p_j$产生的数据，那么整体的<B>代价函数</B>为

$$
\frac{1}{2}\sum_{i=1}^m \sum_{j=1}^n \lVert e_{ij} \rVert^2 = \frac{1}{2}\sum_{i=1}^m \sum_{j=1}^n \lVert z_{ij} - h(T_i, p_j) \rVert^2. \tag{9.42}
$$

对这个最小二乘进行求解，相当于对位姿和路标同时做了调整，也就是所谓的BA。接下来，我们会根据该目标函数和第6讲介绍的非线性优化内容，逐步深入地探讨该模型的求解。

### 9.2.2 BA的求解

观察9.2.1节中的观测模型$h(T,p)$，很容易判断该函数不是线性函数。所以我们希望使用6.2节介绍的一些非线性优化手段来优化它。根据非线性优化的思想，我们应该从某个初始值开始，不断地寻找下降方向$\Delta x$，来找到目标函数的最优解，即不断地求解增量方程(6.33)中的增量$\Delta x$。尽管误差项都是针对单个位姿和路标点的，但在整体BA目标函数上，我们应该把自变量定义成所有待优化的变量：

$$
x = [T_1,...,T_m,p_1,...,p_n]^T. \tag{9.43}
$$

相应地，增量方程中的$\Delta x$则是对整体自变量的增量。在这个意义下，当我们给自变量一个增量时，目标函数变为

$$
\frac{1}{2}\lVert f(x + \Delta x) \rVert^2 \approx \frac{1}{2}\sum_{i=1}^m \frac{1}{2}\sum_{j=1}^n \lVert e_{ij} + F_{ij} \Delta \xi_i + E_{ij} \Delta p_j \rVert^2. \tag{9.44}
$$

其中，$F_{ij}$表示整个代价函数在当前状态下对相机姿态的偏导数，而$E_{ij}$表示该函数对路标点位置的偏导。我们曾在7.3.3节中介绍了它们的具体形式。现在，把相机位姿变量放在一起：

$$
x_c = [\xi_1, \xi_2,..., \xi_m]^T \in \mathbb{R}^{6m}, \tag{9.45}
$$

并把空间点的变量也放在一起：

$$
x_p = [p_1,p_2,...,p_n]^T \in \mathbb{R}^{3n}, \tag{9.46}
$$

那么，式(9.44)可以简化表达如下：

$$
\frac{1}{2}\lVert f(x + \Delta x) \rVert^2 = \frac{1}{2} \lVert e + F \Delta x_c + E \Delta x_p \rVert^2. \tag{9.47}
$$

需要注意的是，该式从一个由很多小型二次项之和，变成矩阵形式。这里的雅可比矩阵$E$和$F$必须是整体目标函数对整体变量的导数，它将是一个很大块的矩阵，而里头每个小分块，需要由每个误差项的导数$F_{ij}$和$E_{ij}$“拼凑”起来。然后，无论我们使用高斯牛顿法还是列文伯格-马奈尔特方法，最后都将面对增量线性方程：

$$
H \Delta x = g. \tag{9.48}
$$

根据第6讲的知识，我们知道高斯牛顿法和列文伯格-马奈尔特方法的主要差别在于，这里的$H$是取$J^TJ$还是$J^TJ + \lambda I$的形式。由于我们把变量归类成了位姿和空间点两种，所以雅可比矩阵可以分块为

$$
J = [F\quad E]. \tag{9.49}
$$

那么，以高斯牛顿法为例，则$H$矩阵为

$$
H = J^TJ = \begin{bmatrix}
    F^TF & F^TE \\
    E^TF & E^TE
\end{bmatrix}. \tag{9.50}
$$

当然，在列文伯格-马奈尔特方法中我们也需要计算这个矩阵。不难发现，因为考虑了所有的优化变量，所以这个线性方程的维度将非常大，包含了所有的相机位姿和路标点。尤其是在视觉SLAM中，一幅图像会提出数百个特征点，大大增加了这个线性方程的规模。如果直接对$H$求逆来计算增量方程，由于矩阵求逆是复杂度为$O(n^3)$的操作，那么消耗的计算资源会非常多。幸运的是，这里的$H$矩阵是有一定的特殊结构的。利用这个特殊结构，可以加速求解过程。

### 9.2.3 稀疏性和边缘化

21世纪视觉SLAM的一个重要进展是认识到了矩阵$H$的稀疏结构，并发现该结构可以自然、显式地用图优化来表示。本节将详细讨论该矩阵的稀疏结构。

$H$矩阵的稀疏性是由雅可比矩阵$J(x)$引起的，考虑这些代价函数当中的其中一个$e_{ij}$。注意，这个误差项只描述了在$T_i$看到$p_j$这件事，只涉及第$i$个相机位姿和第$j$个路标点，对其余部分的变量的导数都为0。所以该误差项对应的雅可比矩阵有下面的形式：

$$
J_{ij}(x) = \left(
    0_{2\times6},...,0_{2\times6},\frac{\partial e_{ij}}{\partial T_i}, 0_{2\times6}, ..., 0_{2\times3},...,0_{2\times3},\frac{\partial e_{ij}}{\partial p_j}, 0_{2\times3}, ..., 0_{2\times3}. \tag{9.51}
\right)
$$

其中$0_{2\times6}$表示维度为$2\times6$的$0$矩阵，同理，$0_{2\times3}$也是一样的。该误差项对相机姿态的偏导$\partial e_{ij}/\partial \xi_i$维度为$2\times6$，对路标点的偏导$\partial e_{ij}/\partial p_j$的维度是$2\times3$。这个误差项的雅可比矩阵，除了这两处为非零块，其余地方都为零。这体现了该误差项与其他路标和轨迹无关的特性。从图优化的角度来说，这条观测边只和两个顶点有关。那么，它对增量方程有何影响？$H$矩阵为什么会产生稀疏性呢？

以下图为例，我们假设$J_{ij}$只在$i,j$处有非零块，那么它对$H$的贡献为$J_{ij}^TJ_{ij}$，具有图上所画的稀疏形式。这个$J^T_{ij} J_{ij}$矩阵也仅有4个非零块，位于$(i,i),(i,j),(j,i),(j,j)$。对于整体的$H$，有

$$
H = \sum_{i,j}J_{ij}^TJ_{ij}, \tag{9.52}
$$

请注意，$i$在所有相机位姿中取值，$j$在所有路标点中取值。我们把$H$进行分块：

$$
H = \begin{bmatrix}
    H_{11} & H_{12} \\
    H_{21} & H_{22}
\end{bmatrix}. \tag{9.53}
$$

<div align=center>
    <img src="../image/H矩阵稀疏性.png" />
</div>

> 当某个误差项$J$具有稀疏性时，它对$H$的贡献也具有稀疏形式

这里，$H_{11}$只和相机位姿有关，而$H_{22}$只和路标点有关。当我们遍历$i,j$时，以下事实总是成立的：

1. 不管$i,j$怎么变，$H_{11}$都是对角阵，只在$H_{ii}$处有非零块。
2. 同理，$H_{22}$也是对角阵，只在$H_{jj}$处有非零块。
3. 对于$H_{12}$和$H_{21}$，它们可能是稀疏的，也可能是稠密的，视具体的观测数据而定。

这显示了$H$的稀疏结构。之后对线性方程的求解中，也正需要利用它的稀疏结构。举个实例：假设一个场景内有2个相机位姿$(C_1,C_2)$和6个路标点$(P_1,P_2,P_3,P_4,P_5,P_6)$，这些相机和点云所对应的变量为$T_i,i=1,2$及$p_j,j=1,...,6$。相机$C_1$观测到路标点$P_1,P_2,P_3,P_4$，相机$C_2$观测到路标点$P_3,P_4,P_5,P_6$。我们把这个过程画成示意图，如下图所示。相机和路标以圆形节点表示。如果$i$相机能够直观观测到$j$点，我们就在它们对应的节点连上一条边。

<div align=center>
    <img src="../image/点和边组成的示意图.png" />
    <center><p>图 9-4</p></center>
</div>

> 该图显示相机$C_1$观测到了路标点$P_1,P_2,P_3,P_4$，相机$C_2$看到了路标点$P_3 \sim P_6$

可以推出，场景下的BA目标函数应该为

$$
\frac{1}{2}\left( \lVert e_{11} \rVert^2 +  \lVert e_{12} \rVert^2 +  \lVert e_{13} \rVert^2 +  \lVert e_{14} \rVert^2 +  \lVert e_{23} \rVert^2 +  \lVert e_{24} \rVert^2 +  \lVert e_{25} \rVert^2 +  \lVert e_{26} \rVert^2  \right). \tag{9.54}
$$

这里的$e_{ij}$使用之前定义过的代价函数，即式(9.42)。以$e_{11}$为例，它描述了在$C_1$看到了$P_1$这件事，与其他的相机位姿和路标无关。令$J_{11}$为$e_{11}$所对应的雅可比矩阵，不难看出$e_{11}$对相机变量$\xi_2$和路标点$p_2,...,p_6$的偏导都为0。我们把所有变量以$x=(\xi_1,\xi_2,p_1,...,p_2)^T$的顺序摆放，则有

$$
J_{11} = \frac{\partial e_{11}}{\partial x} = \left(
    \frac{\partial e_{11}}{\partial \xi_1}, 0_{2\times6}, \frac{\partial e_{11}}{\partial p_1}, 0_{2\times3}, 0_{2\times3}, 0_{2\times3}, 0_{2\times3}, 0_{2\times3}
\right). \tag{9.55}
$$

为了方便表示稀疏性，我们用带有颜色的方块表示矩阵在该方块内有数值，其余没有颜色的区域表示矩阵在该处数值都为0.那么上面的$J_{11}$则可以表示成如下图所示的图案。同理，其他的雅可比矩阵也会有类似的稀疏图案。

<div align=center>
    <img src="../image/J11矩阵的非零块分布图.png" />
    <center><p>图 9-5</p></center>
</div>

> 上方的标记表示矩阵该列所对应的变量。由于相机参数维数比点云参数维数大，所以$C_1$对应的矩阵块要比$P_1$对应的矩阵块宽

为了得到该目标函数对应的雅可比矩阵，可以将这些$J_{ij}$按照一定顺序列为向量，那么整体雅可比矩阵及相应的$H$矩阵的稀疏情况就如下图所示：

<div>
    <center>
        <img src="../image/雅可比矩阵和H矩阵稀疏性.png" />
        <br/>
        图 9-6
    </center>
</div>

可以看到，图9-4对应的<B>邻接矩阵</B>(Adjacency Matrix)和图9-6中的$H$矩阵，除了对角元素外的其余部分有着完全一致的结构。事实上也的确如此，上面的$H$矩阵一共有