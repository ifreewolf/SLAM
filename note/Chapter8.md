# 第8讲 视觉里程计2

<div style="border: 1px solid black;">
<B>主要目标</B>

1. 理解光流法跟踪特征点的原理。
2. 理解直接法是如何估计相机位姿。
3. 实现多层直接法的计算。
</div>

直接法是视觉里程计的另一个主要分支，它与特征点法有很大不同。虽然它没有成为现在视觉里程计中的主流，但经过近几年的发展，直接法在一定程度上已经能和特征点法平分秋色。

## 8.1 直接法的引出

第7讲介绍了使用特征点估计相机运动的方法，尽管特征点法在视觉里程计中占据主流地位，但研究者们还是认识到它至少有以下几个缺点：

1. 关键点的提取与描述子的计算非常耗时。实践中，SIFT目前在CPU上是无法实时计算的，而ORB也需要近20毫秒的计算时长。如果整个SLAM以30毫秒/帧的速度运动，那么一大半时间都将花在计算特征点上。
2. 使用特征点时，忽略了除特征点以外的所有信息。一幅图像有几十万个像素，而特征点只有几百个。只使用特征点丢弃了大部分<B>可能有用的</B>图像信息。
3. 相机有时会运动到<B>特征缺失</B>的地方，这些地方往往没有明显的纹理信息。例如，有时会面对一堵白墙，或者一个空荡荡的走廊。这些场景下特征点数量会明显减少，我们可能找不到足够的匹配点来计算相机运动。

可以看到，特征点确实存在一些问题，有没有办法可以克服这些缺点呢？有以下几种思路：

- 保留特征点，但只计算关键点，不计算描述子。同时，使用<B>光流法(Optical Flow)</B>跟踪特征点的运动。这样可以回避计算和匹配描述子带来的时间，而光流本身的计算时间要小于描述子的计算与匹配。
- 只计算关键点，不计算描述子。同时，使用<B>直接发(Direct Mehtod)</B>计算特征点在下一时刻图像中的位置。这同样可以跳过描述子的计算过程，也省去了光流的计算时间。

第一种方法仍然使用特征点，只是把匹配描述子替换成了光流跟踪，估计相机运动仍使用对极几何、PnP或ICP算法。这依然会要求提取到的关键点具有可区别性，即需要提取到角点。而在直接法中，会根据图像的<B>像素灰度信息</B>同时估计相机运动和点的投影，不要求提取到的点必须为角点。甚至可以是随机的选点。

使用特征点法估计相机运动时，把特征点看作固定在三维空间的不动点。根据它们在相机中的投影位置，通过最小化<B>重投影误差(Reprojection error)</B>优化相机运动。在这个过程中，需要精确地知道空间点在两个相机中投影后的像素位置-- 这也就是我们要对特征进行匹配或跟踪的原因。同时，计算、匹配特征需要付出大量的计算量。相对地，在直接法中，我们并不需要知道点与点之间的对应关系，而是通过最小化<B>光度误差(Photometric error)</B>来求得它们。

直接法克服特征点法得上述缺点而存在，直接法根据像素的亮度信息估计相机得运动，可以完全不用计算关键点和描述子，于是，既避免了特征的计算时间，也避免了特征缺失的情况。只要场景中存在明暗变化(可以是渐变，不形成局部的图像梯度)，直接法就能工作。根据使用像素的数量，直接法分为稀疏、稠密和半稠密三种。与特征点法只能重构稀疏特征点(稀疏地图)相比，直接法还具有恢复稠密或半稠密结构的能力。

---

## 8.2 2D 光流

直接法是从光流法演变而来的，非常相似，具有相同的假设条件。光流描述了像素在图形中的运动，而直接法则附带着一个相机运动模型。先介绍光流：

光流是一种描述像素随时间在图像之间运动的方法，如下图所示，随着时间的流逝，同一个像素会在图像中运动，而我们希望追踪它的运动过程。其中，计算部分像素运动的称为<B>稀疏光流</B>，计算所有像素的称为<B>稠密光流</B>。稀疏光流以Lucas-Kanade光流为代表，并可以在SLAM中用于跟踪特征点位置。稠密光流以Horn-Schunck光流为代表，因此此，本节主要介绍Lucas-Kanade光流，也称为LK光流。

<div align=center>
    <img src="./image/LK光流法示意图.png" />
</div>

### Lucas-Kanade光流

在LK光流中，我们认为来自相机的图像是随时间变化的。图像可以看作时间的函数：$T(t)$。那么，一个在$t$时刻，位于$(x,y)$处的像素，它的灰度可以写成

$$
I(x,y,t).
$$

这种方式把图像看成了关于位置与时间的函数，它的值域就是图像中像素的灰度。现在考虑某个固定的空间点，它在$t$时刻的像素坐标为$x,y$。由于相机的运动，它的图像坐标将发生变化。我们希望估计这个空间点在其他时刻图像中的位置。怎么估计呢？这里要引入光流法的基本假设。

<B>灰度不变假设</B>：同一个空间点的像素灰度值，在各个图像中是固定不变的。

对于$t$时刻位于$(x,y)$处的像素，我们设$t+dt$时刻它运动拿到$(x+dx,y+dy)$处。<B>由于灰度不变</B>，我们有

$$
I(x + dx, y + dy, t + dt) = I(x, y, t). \tag{8.1}
$$

上面写灰度不变是一个很强的假设，实际中很可能不成立。事实上，由于物体的材质不同，像素会出现高光和阴影部分；有时，相机会自动调整曝光参数，使得图像整体变亮或变暗。这时灰度不变假设都是不成立的，因此光流的结果也不一定可靠。然而，从另一方面说，所有算法都是在一定假设下工作的。如果我们什么假设都不做，就没法设计实用的算法。所以，让我们暂时认为该假设成立，看看如何计算像素的运动。

对左边进行泰勒展开，保留一阶项，得

$$
I(x + dx, y + dy, t + dt) \approx I(x, y, t) + \frac{\partial I}{\partial x} dx + \frac{\partial I}{\partial y}dy + \frac{\partial I}{\partial t}dt. \tag{8.2}
$$

因为假设了灰度不变，于是下一时刻的灰度等于之前的灰度，从而：

$$
\frac{\partial I}{\partial x}dx + \frac{\partial I}{\partial y}dy + \frac{\partial I}{\partial t}dt = 0. \tag{8.3}
$$

两边除以$dt$，得

$$
\frac{\partial I}{\partial x}\frac{dx}{dt} + \frac{\partial I}{\partial y}\frac{dy}{dt} = -\frac{\partial I}{\partial t}. \tag{8.4}
$$

其中$dx/dt$为像素在$x$轴上的运动速度，而$dy/dt$为$y$轴上的速度，把它们记为$u,v$。同时，$\partial I / \partial x$为图像在该点处$x$方向的梯度，另一项则是在$y$方向的梯度，记为$I_x,I_y$。把图像灰度对时间的变化量记为$I_t$，写成矩阵形式，有

$$
\begin{bmatrix}
    I_x & I_y
\end{bmatrix} \begin{bmatrix}
    u \\ v
\end{bmatrix} = -I_t. \tag{8.5}
$$

我们想计算的是像素的运动$u,v$，但是该式是带有两个变量的一次，仅凭它无法计算出$u,v$。因此，必须引入额外的约束来计算$u,v$。在LK光流中，假设<B>某一个窗口内的像素具有相同的运动</B>。

考虑一个大小为$w\times w$的窗口，它含有$w^2$数量的像素。该窗口内像素具有同样的运动，因为我们共有$w^2$个方程：

$$
\begin{bmatrix}
    I_x & I_y
\end{bmatrix}_k \begin{bmatrix}
    u \\ v
\end{bmatrix} = -I_{tk}, \quad k=1,...,w^2. \tag{8.6}
$$

记：

